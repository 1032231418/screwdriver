#!/usr/bin/env node
'use strict';

const winston = require('winston');
const config = require('config');

// Setup Datastore
const datastoreConfig = config.get('datastore');
const DatastorePlugin = require(`screwdriver-datastore-${datastoreConfig.plugin}`);
const datastore = new DatastorePlugin(datastoreConfig[datastoreConfig.plugin]);

// Setup Executor
const executorConfig = config.get('executor');
const ExecutorPlugin = require(`screwdriver-executor-${executorConfig.plugin}`);
const executor = new ExecutorPlugin(executorConfig[executorConfig.plugin]);

// Setup Login
const loginConfig = config.get('login');

loginConfig.datastore = datastore;

// Setup httpd
const httpdConfig = config.get('httpd');
const port = httpdConfig.port;

// Setup GitHub Webhooks
const gitHubSecret = config.get('webhooks.github.secret');

require('../')({
    port,
    datastore,
    login: loginConfig,
    builds: {
        datastore,
        executor
    },
    github: {
        datastore,
        secret: gitHubSecret
    }
}, (err, server) => {
    if (err) {
        winston.error(err);

        return process.exit(1);
    }

    return winston.info('Server running at %s', server.info.uri);
});
