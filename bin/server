#!/usr/bin/env node
'use strict';

const winston = require('winston');
const config = require('config');

// Setup Datastore
const datastoreConfig = config.get('datastore');
const DatastorePlugin = require(`screwdriver-datastore-${datastoreConfig.plugin}`);
const datastore = new DatastorePlugin(datastoreConfig[datastoreConfig.plugin]);

// Setup Executor
const executorConfig = config.get('executor');
const ExecutorPlugin = require(`screwdriver-executor-${executorConfig.plugin}`);
const executor = new ExecutorPlugin(executorConfig[executorConfig.plugin]);

// Setup Login
const loginConfig = config.get('login');

// Setup httpd
const httpdConfig = config.get('httpd');

// Setup GitHub Webhooks
const gitHubSecret = config.get('webhooks.github.secret');

// Setup Model Factories
const Models = require('screwdriver-models');
const pipelineFactory = Models.PipelineFactory.getInstance({ datastore });
const jobFactory = Models.JobFactory.getInstance({ datastore });
const userFactory = Models.UserFactory.getInstance({ datastore, password: loginConfig.password });
const buildFactory = Models.BuildFactory.getInstance({ datastore, executor });

require('../')({
    httpd: httpdConfig,
    login: loginConfig,
    pipelineFactory,
    jobFactory,
    userFactory,
    buildFactory,
    pipelines: {
        password: loginConfig.password
    },
    builds: {
        password: loginConfig.password
    },
    webhooks: {
        secret: gitHubSecret,
        password: loginConfig.password
    }
}, (err, server) => {
    if (err) {
        winston.error(err);

        return process.exit(1);
    }

    return winston.info('Server running at %s', server.info.uri);
});
